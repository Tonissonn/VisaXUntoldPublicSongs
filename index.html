<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Untold Beat Mixer - Visa Experience</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0061B2 0%, #1a75d2 50%, #FDB827 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Intro Screen */
        .intro-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            animation: fadeIn 2s ease-in;
        }

        .logo-section {
            margin-bottom: 40px;
        }

        .brand-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .visa-logo-img {
            height: 60px;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .visa-logo-img:hover {
            transform: translateY(-3px);
        }

        .brand-separator {
            color: #FDB827;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .untold-logo-img {
            height: 60px;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
            transition: transform 0.3s ease;
        }

        .untold-logo-img:hover {
            transform: translateY(-3px);
        }

        .experience-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #FDB827;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-top: 20px;
        }

        .intro-text {
            font-size: 1.5rem;
            margin: 30px 0;
            max-width: 600px;
        }

        .start-btn {
            background: linear-gradient(45deg, #FDB827, #ffcc4d);
            color: #0061B2;
            border: none;
            padding: 20px 40px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(253, 184, 39, 0.4);
        }

        /* Sample Selection Screen */
        .sample-selection {
            display: none;
            text-align: center;
        }

        .selection-header {
            margin-bottom: 40px;
            position: relative;
        }

        .selection-brand-mini {
            position: absolute;
            top: -15px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.7;
        }

        .selection-brand-mini img {
            height: 20px;
        }

        .selection-brand-mini .visa-mini-small {
            background: white;
            padding: 3px 6px;
            border-radius: 3px;
        }

        .selection-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #FDB827;
        }

        .selection-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .samples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .sample-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .sample-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .sample-card.selected {
            border-color: #FDB827;
            background: rgba(253, 184, 39, 0.2);
        }

        .sample-name {
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .sample-category {
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .preview-btn {
            background: rgba(253, 184, 39, 0.8);
            color: #0061B2;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px auto;
            display: block;
        }

        .preview-btn:hover {
            background: #FDB827;
            transform: scale(1.1);
        }

        .preview-btn.playing {
            background: #ff6b6b;
            color: white;
        }

        .selected-count {
            font-size: 1.2rem;
            margin: 20px 0;
            color: #FDB827;
        }

        .continue-btn {
            background: linear-gradient(45deg, #0061B2, #1a75d2);
            color: white;
            border: none;
            padding: 15px 35px;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }

        .continue-btn.active {
            opacity: 1;
            pointer-events: all;
        }

        .continue-btn.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 97, 178, 0.3);
        }

        /* Mixer Screen */
        .mixer-screen {
            display: none;
        }

        .mixer-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .mixer-brand-mini {
            position: absolute;
            top: -10px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0.8;
        }

        .mixer-brand-mini img {
            height: 25px;
        }

        .mixer-brand-mini .visa-mini {
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .mixer-title {
            font-size: 2rem;
            color: #FDB827;
            margin-bottom: 10px;
        }

        .timer {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .mixer-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .channels {
            display: flex;
            gap: 20px;
            flex: 1;
            flex-wrap: wrap;
        }

        .channel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            flex: 1;
            min-width: 180px;
            backdrop-filter: blur(10px);
        }

        .channel-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .channel-name {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .channel-category {
            font-size: 0.8rem;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #FDB827, #ffcc4d);
            color: #0061B2;
            font-size: 1.2rem;
            cursor: pointer;
            margin: 10px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .play-btn:hover {
            transform: scale(1.1);
        }

        .play-btn.playing {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
        }

        .volume-control {
            margin: 20px 0;
        }

        .volume-label {
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: block;
        }

        .volume-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #FDB827;
            cursor: pointer;
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            min-width: 250px;
            backdrop-filter: blur(10px);
        }

        .master-controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .master-volume {
            margin: 20px 0;
        }

        .record-btn, .stop-btn, .export-btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .record-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
        }

        .record-btn.recording {
            background: linear-gradient(45deg, #4ecdc4, #6bcf7f);
            animation: pulse 1s infinite;
        }

        .stop-btn {
            background: linear-gradient(45deg, #95a5a6, #bdc3c7);
            color: white;
        }

        .export-btn {
            background: linear-gradient(45deg, #FDB827, #ffcc4d);
            color: #0061B2;
            font-weight: bold;
        }

        .timeline {
            width: 100%;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .timeline-progress {
            height: 100%;
            background: linear-gradient(45deg, #FDB827, #ffcc4d);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 10px;
        }

        .recording-preview {
            margin: 20px 0;
            padding: 15px;
            background: rgba(253, 184, 39, 0.2);
            border-radius: 10px;
            text-align: center;
        }

        .recording-preview audio {
            width: 100%;
            margin: 10px 0;
        }

        /* Export Screen */
        .export-screen {
            display: none;
            text-align: center;
            padding: 50px 0;
        }

        .export-title {
            font-size: 2.5rem;
            color: #FDB827;
            margin-bottom: 30px;
        }

        .email-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .email-input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.9);
            color: #0061B2;
        }

        .send-btn {
            background: linear-gradient(45deg, #0061B2, #1a75d2);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 97, 178, 0.3);
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
            margin: 20px 10px;
        }

        .success-message {
            background: linear-gradient(45deg, #4ecdc4, #6bcf7f);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .file-upload-area {
            background: rgba(255, 255, 255, 0.1);
            border: 3px dashed #FDB827;
            border-radius: 15px;
            padding: 40px;
            margin: 30px 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            background: rgba(253, 184, 39, 0.2);
            border-color: white;
        }

        .file-upload-area.dragover {
            background: rgba(253, 184, 39, 0.3);
            border-color: white;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #FDB827;
        }

        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .skip-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .skip-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .upload-progress {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(45deg, #FDB827, #ffcc4d);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .channels {
                flex-direction: column;
            }
            
            .mixer-container {
                flex-direction: column;
            }
            
            .samples-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- File Upload Screen -->
        <div class="sample-selection" id="fileUploadScreen" style="display: none;">
            <div class="selection-header">
                <div class="selection-brand-mini">
                    <img src="https://cdn.visa.com/v2/assets/images/logos/visa/blue/logo.png" alt="Visa" class="visa-mini-small">
                    <span style="color: #FDB827; font-size: 0.7rem;">✕</span>
                    <img src="https://untold.com/_next/image?url=https%3A%2F%2Funtold-universe-public-resources-dev.s3.eu-west-1.amazonaws.com%2Funtold-logo-light%25403x.png&w=256&q=75" alt="Untold">
                </div>
                <h2 class="selection-title">Load Your Samples</h2>
                <p class="selection-subtitle">Upload your 25 Splice samples for the best experience</p>
            </div>
            
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">📁</div>
                <div class="upload-text">Click here or drag & drop your sample files</div>
                <div class="upload-subtext">Select all 25 .wav files from your sounds/ folder</div>
                <div class="upload-progress" id="uploadProgress">
                    <div>Loaded: <span id="fileCount">0</span>/25 samples</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
            
            <button class="skip-btn" onclick="useGeneratedSamples()">Skip - Use Generated Samples</button>
            <button class="continue-btn active" id="continueFromUpload" onclick="goToSampleSelection()" style="display: none;">Continue with Loaded Samples</button>
        </div>
        
        <!-- Intro Screen -->
        <div class="intro-screen" id="introScreen">
            <div class="logo-section">
                <div class="brand-logos">
                    <img src="https://cdn.visa.com/v2/assets/images/logos/visa/blue/logo.png" alt="Visa" class="visa-logo-img">
                    <div class="brand-separator">✕</div>
                    <img src="https://untold.com/_next/image?url=https%3A%2F%2Funtold-universe-public-resources-dev.s3.eu-west-1.amazonaws.com%2Funtold-logo-light%25403x.png&w=256&q=75" alt="Untold" class="untold-logo-img">
                </div>
                <div class="experience-title">Beat Creation Experience</div>
            </div>
            <div class="intro-text">
                Create your unique beat mix with professional samples from Splice.<br>
                Select 5 sounds, mix them live, and take your creation home!
            </div>
            <button class="start-btn" onclick="loadSamplesAndStart()">Load Samples & Start</button>
            <div id="loadingStatus" style="margin-top: 20px; font-size: 1rem; opacity: 0.8; display: none;">
                Loading samples... <span id="loadingCount">0/25</span>
            </div>
        </div>

        <!-- Sample Selection Screen -->
        <div class="sample-selection" id="sampleSelection">
            <div class="selection-header">
                <div class="selection-brand-mini">
                    <img src="https://cdn.visa.com/v2/assets/images/logos/visa/blue/logo.png" alt="Visa" class="visa-mini-small">
                    <span style="color: #FDB827; font-size: 0.7rem;">✕</span>
                    <img src="https://untold.com/_next/image?url=https%3A%2F%2Funtold-universe-public-resources-dev.s3.eu-west-1.amazonaws.com%2Funtold-logo-light%25403x.png&w=256&q=75" alt="Untold">
                </div>
                <h2 class="selection-title">Choose Your Sounds</h2>
                <p class="selection-subtitle">Select exactly 5 samples to create your mix</p>
                <div class="selected-count" id="selectedCount">0 / 5 selected</div>
            </div>
            
            <div class="samples-grid" id="samplesGrid">
                <!-- Samples will be populated by JavaScript -->
            </div>
            
            <button class="continue-btn" id="continueBtn" onclick="goToMixer()">Continue to Mixer</button>
        </div>

        <!-- Mixer Screen -->
        <div class="mixer-screen" id="mixerScreen">
            <div class="mixer-header">
                <div class="mixer-brand-mini">
                    <img src="https://cdn.visa.com/v2/assets/images/logos/visa/blue/logo.png" alt="Visa" class="visa-mini">
                    <span style="color: #FDB827; font-size: 0.8rem;">✕</span>
                    <img src="https://untold.com/_next/image?url=https%3A%2F%2Funtold-universe-public-resources-dev.s3.eu-west-1.amazonaws.com%2Funtold-logo-light%25403x.png&w=256&q=75" alt="Untold">
                </div>
                <h2 class="mixer-title">Live Beat Mixer</h2>
                <div class="timer" id="timer">00:00 / 00:40</div>
            </div>
            
            <div class="mixer-container">
                <div class="channels" id="channels">
                    <!-- Channels will be populated by JavaScript -->
                </div>
                
                <div class="controls-panel">
                    <div class="master-controls">
                        <h3>Master Controls</h3>
                        <div class="master-volume">
                            <label class="volume-label">Master Volume</label>
                            <input type="range" class="volume-slider" id="masterVolume" min="0" max="100" value="70">
                        </div>
                        <div class="timeline" id="timeline">
                            <div class="timeline-progress" id="timelineProgress"></div>
                        </div>
                    </div>
                    
                    <button class="record-btn" id="recordBtn" onclick="toggleRecording()">● Record</button>
                    <button class="stop-btn" onclick="stopAll()">■ Stop All</button>
                    <button class="export-btn" onclick="exportMix()">Export Mix</button>
                    
                    <button class="back-btn" onclick="goToSampleSelection()">← Back to Samples</button>
                </div>
            </div>
        </div>

        <!-- Export Screen -->
        <div class="export-screen" id="exportScreen">
            <div style="position: relative;">
                <div class="selection-brand-mini" style="top: 0;">
                    <img src="https://cdn.visa.com/v2/assets/images/logos/visa/blue/logo.png" alt="Visa" class="visa-mini-small">
                    <span style="color: #FDB827; font-size: 0.7rem;">✕</span>
                    <img src="https://untold.com/_next/image?url=https%3A%2F%2Funtold-universe-public-resources-dev.s3.eu-west-1.amazonaws.com%2Funtold-logo-light%25403x.png&w=256&q=75" alt="Untold">
                </div>
                <h2 class="export-title">Your Beat is Ready!</h2>
            </div>
            <p>Enter your email to receive your unique creation:</p>
            
            <div class="email-form">
                <input type="email" class="email-input" id="emailInput" placeholder="your.email@example.com" required>
                <button class="send-btn" onclick="sendEmail()">Send My Beat</button>
                <div class="success-message" id="successMessage">
                    🎉 Beat sent successfully! Check your email.
                </div>
            </div>
            
            <button class="back-btn" onclick="goToMixer()">← Back to Mixer</button>
            <button class="back-btn" onclick="startOver()">Start Over</button>
        </div>
    </div>

    <script>
        // Global variables
        let selectedSamples = [];
        let loadedSamples = {};
        let isRecording = false;
        let recordingStartTime = 0;
        let maxRecordingTime = 40; // seconds
        let recordingTimer;
        let masterGainNode;
        let audioContext;
        let mediaRecorder;
        let recordedChunks = [];
        let recordedBlob;
        let recordedAudioURL;
        let currentPreviewAudio = null;

        // Sample library with real Splice files and better names
        const sampleLibrary = [
            // DRUMS (8 samples)
            {id: 'kick1', name: 'Festival Kick', category: 'Drums', file: 'T_MDT4_128_kick_loop_transpire.wav'},
            {id: 'kick2', name: 'Deep House Kick', category: 'Drums', file: '04_HED_Kit_10_Kick_F#.wav'},
            {id: 'kick3', name: 'Power Kick', category: 'Drums', file: 'FL_PHW_Kit07_KICK.wav'},
            {id: 'snare1', name: 'Rolling Snare', category: 'Drums', file: 'AU_BR2_128_snare_loop_kit1_roll_wet_F.wav'},
            {id: 'clap1', name: 'Big Room Clap', category: 'Drums', file: 'Clap_1.wav'},
            {id: 'hihat1', name: 'Trance Hi-Hats', category: 'Drums', file: '016_Hi-Hat_Loop_128bpm_-_VTRANCEHH_Zenhiser.wav'},
            {id: 'hihat2', name: 'Open Hi-Hat', category: 'Drums', file: 'ZEN_GSG_open_hi_hat_one_shot_short.wav'},
            {id: 'perc1', name: 'Shaker Loop', category: 'Drums', file: 'T_TSJF_128_shaker_loop_partelo.wav'},

            // BASS (5 samples)
            {id: 'bass1', name: 'Progressive Bass', category: 'Bass', file: '019_c__PHG_Zenhiser_-_Bass_Loop_128bpm_C1.wav'},
            {id: 'bass2', name: 'Broken Bass', category: 'Bass', file: 'bt2_bass_synth_loop_broken_128_Bbm.wav'},
            {id: 'bass3', name: 'Snake Bass', category: 'Bass', file: 'BOS_TB_128_Bass_Synth_Loop_Snake_Fm.wav'},
            {id: 'bass4', name: 'Lectra Wave', category: 'Bass', file: 'ph_syn_128_lectrawave_E.wav'},
            {id: 'bass5', name: 'Future Bass', category: 'Bass', file: 'pt_kit32_strings_lead_synth_loop_128_Fm.wav'},

            // MELODIC (8 samples)
            {id: 'lead1', name: 'Pluck Lead', category: 'Melodic', file: 'FL_128_BPM_Pluck_Lead_A.wav'},
            {id: 'pad1', name: 'Warm Pad', category: 'Melodic', file: 'BOS_GTC_128_Synth_Pad_Loop_Warm_C#m.wav'},
            {id: 'piano1', name: 'Classic House Piano', category: 'Melodic', file: 'ff_mmht_128_piano_loop_classichouse_Fmaj.wav'},
            {id: 'strings1', name: 'Violin Section', category: 'Melodic', file: 'SS_-_Kit_4_-_Violin_2.wav'},
            {id: 'arp1', name: 'Synth Arp Pieces', category: 'Melodic', file: 'BOS_CHE_128_Synth_Arp_Loop_Pieces_Gm.wav'},
            {id: 'arp2', name: 'Acid Arp', category: 'Melodic', file: 'T_MHT_128_arp_loop_acid_D.wav'},
            {id: 'full1', name: 'Full Drum Loop', category: 'Melodic', file: '09_FB_Drum_Loop_Full_128.wav'},
            {id: 'top1', name: 'Top Loop', category: 'Melodic', file: '02_FB_Drum_Loop_Top_Loop_128.wav'},

            // VOCALS (2 samples)
            {id: 'vocal1', name: 'Festival Shout', category: 'Vocals', file: 'Vocal_Shout1.wav'},
            {id: 'vocal2', name: 'Bad Vocal Loop', category: 'Vocals', file: 'FSS_DPPE_128_vocal_loop_bad.wav'},

            // EFFECTS (2 samples)
            {id: 'fx1', name: 'Zero Riser', category: 'Effects', file: 'PMCA_FX_Riser_128_2_Zero.wav'},
            {id: 'fx2', name: 'Atmosphere Impact', category: 'Effects', file: 'lfmt_128_atmosphere_loop_impact_Bbmaj.wav'}
        ];

        // Initialize audio context and EmailJS
        async function initializeAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create master gain node
                masterGainNode = audioContext.createGain();
                masterGainNode.connect(audioContext.destination);
                masterGainNode.gain.value = 0.7;
                
                console.log('Audio context initialized');
                
                // Initialize EmailJS
                emailjs.init("Bl01SmrI5sNsewj5q");
                
                // Load all samples
                await loadAllSamples();
                
            } catch (error) {
                console.error('Failed to initialize audio:', error);
                alert('Audio initialization failed. Please refresh and try again.');
            }
        }

        // Show file upload screen
        async function showFileUpload() {
            await initializeAudioContext();
            
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('fileUploadScreen').style.display = 'block';
            
            setupFileUpload();
        }

        // Setup drag & drop file upload
        function setupFileUpload() {
            const uploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            // Handle dropped files
            uploadArea.addEventListener('drop', handleDrop, false);
            
            // Handle file input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            document.getElementById('fileUploadArea').classList.add('dragover');
        }

        function unhighlight(e) {
            document.getElementById('fileUploadArea').classList.remove('dragover');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // Process uploaded files
        async function handleFiles(files) {
            const progressDiv = document.getElementById('uploadProgress');
            const countSpan = document.getElementById('fileCount');
            const progressFill = document.getElementById('progressFill');
            
            progressDiv.style.display = 'block';
            
            let loadedCount = 0;
            
            for (let file of files) {
                if (file.type.startsWith('audio/')) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        
                        // Match file to sample based on filename
                        const matchedSample = findSampleByFilename(file.name);
                        if (matchedSample) {
                            loadedSamples[matchedSample.id] = {
                                buffer: audioBuffer,
                                source: null,
                                gainNode: null,
                                isPlaying: false
                            };
                            
                            loadedCount++;
                            countSpan.textContent = loadedCount;
                            progressFill.style.width = (loadedCount / 25) * 100 + '%';
                            
                            console.log(`✓ Loaded: ${matchedSample.name} (${file.name})`);
                        }
                    } catch (error) {
                        console.error(`Failed to load ${file.name}:`, error);
                    }
                }
            }
            
            // Fill remaining with generated samples
            await fillMissingSamples();
            
            // Show continue button
            document.getElementById('continueFromUpload').style.display = 'block';
            
            console.log(`Loaded ${loadedCount} real samples, generated ${25 - loadedCount} demo samples`);
        }

        // Find sample by filename
        function findSampleByFilename(filename) {
            return sampleLibrary.find(sample => sample.file === filename);
        }

        // Fill missing samples with generated ones
        async function fillMissingSamples() {
            for (const sample of sampleLibrary) {
                if (!loadedSamples[sample.id]) {
                    const demoBuffer = createDemoSample(sample.category);
                    loadedSamples[sample.id] = {
                        buffer: demoBuffer,
                        source: null,
                        gainNode: null,
                        isPlaying: false
                    };
                }
            }
        }

        // Skip to generated samples
        async function useGeneratedSamples() {
            const progressDiv = document.getElementById('uploadProgress');
            const countSpan = document.getElementById('fileCount');
            const progressFill = document.getElementById('progressFill');
            
            progressDiv.style.display = 'block';
            
            // Generate all samples
            for (let i = 0; i < sampleLibrary.length; i++) {
                const sample = sampleLibrary[i];
                const demoBuffer = createDemoSample(sample.category);
                loadedSamples[sample.id] = {
                    buffer: demoBuffer,
                    source: null,
                    gainNode: null,
                    isPlaying: false
                };
                
                countSpan.textContent = i + 1;
                progressFill.style.width = ((i + 1) / 25) * 100 + '%';
                
                // Small delay for visual effect
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            // Show continue button
            document.getElementById('continueFromUpload').style.display = 'block';
            
            console.log('Generated all 25 demo samples');
        }

        function goToSampleSelection() {
            document.getElementById('fileUploadScreen').style.display = 'none';
            document.getElementById('sampleSelection').style.display = 'block';
            
            // Populate samples grid
            populateSamplesGrid();
        }

        async function initializeAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create master gain node
                masterGainNode = audioContext.createGain();
                masterGainNode.connect(audioContext.destination);
                masterGainNode.gain.value = 0.7;
                
                console.log('Audio context initialized');
                
                // Initialize EmailJS
                emailjs.init("Bl01SmrI5sNsewj5q");
                
            } catch (error) {
                console.error('Failed to initialize audio:', error);
                alert('Audio initialization failed. Please refresh and try again.');
            }
        }

        // Create demo samples procedurally when real files can't be loaded
        function createDemoSample(category) {
            const sampleRate = audioContext.sampleRate;
            const duration = 2; // 2 seconds
            const buffer = audioContext.createBuffer(2, sampleRate * duration, sampleRate);
            
            const leftChannel = buffer.getChannelData(0);
            const rightChannel = buffer.getChannelData(1);
            
            for (let i = 0; i < buffer.length; i++) {
                let sample = 0;
                const t = i / sampleRate;
                
                switch (category) {
                    case 'Drums':
                        // Kick drum envelope
                        sample = Math.sin(2 * Math.PI * 60 * t) * Math.exp(-t * 10) * 0.5;
                        break;
                    case 'Bass':
                        // Bass tone
                        sample = Math.sin(2 * Math.PI * 80 * t) * 0.3;
                        break;
                    case 'Melodic':
                        // Melodic content
                        sample = Math.sin(2 * Math.PI * 440 * t) * 0.2;
                        break;
                    case 'Vocals':
                        // Vocal-like formant
                        sample = Math.sin(2 * Math.PI * 220 * t) * 0.2;
                        break;
                    case 'Effects':
                        // Sweep effect
                        const freq = 100 + (t * 1000);
                        sample = Math.sin(2 * Math.PI * freq * t) * 0.1;
                        break;
                    default:
                        sample = Math.sin(2 * Math.PI * 440 * t) * 0.1;
                }
                
                leftChannel[i] = sample;
                rightChannel[i] = sample;
            }
            
            return buffer;
        }

        // UI Functions
        async function startExperience() {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('sampleSelection').style.display = 'block';
            
            // Initialize audio
            await initializeAudio();
            
            // Populate samples grid
            populateSamplesGrid();
        }

        function populateSamplesGrid() {
            const grid = document.getElementById('samplesGrid');
            grid.innerHTML = '';
            
            sampleLibrary.forEach(sample => {
                const card = document.createElement('div');
                card.className = 'sample-card';
                card.dataset.sampleId = sample.id;
                
                card.innerHTML = `
                    <div class="sample-name">${sample.name}</div>
                    <div class="sample-category">${sample.category}</div>
                    <button class="preview-btn" onclick="previewSample('${sample.id}', this, event)">▶</button>
                `;
                
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('preview-btn')) {
                        selectSample(sample.id, card);
                    }
                });
                
                grid.appendChild(card);
            });
        }

        function previewSample(sampleId, button, event) {
            event.stopPropagation();
            
            // Stop current preview if playing
            if (currentPreviewAudio) {
                currentPreviewAudio.stop();
                document.querySelectorAll('.preview-btn').forEach(btn => {
                    btn.textContent = '▶';
                    btn.classList.remove('playing');
                });
            }
            
            // If same button, just stop
            if (button.classList.contains('playing')) {
                currentPreviewAudio = null;
                return;
            }
            
            // Play new preview
            const sampleData = loadedSamples[sampleId];
            if (sampleData && sampleData.buffer) {
                const source = audioContext.createBufferSource();
                source.buffer = sampleData.buffer;
                source.connect(audioContext.destination);
                source.start();
                
                button.textContent = '⏸';
                button.classList.add('playing');
                currentPreviewAudio = source;
                
                // Stop after 3 seconds or when it ends
                setTimeout(() => {
                    if (currentPreviewAudio === source) {
                        source.stop();
                        button.textContent = '▶';
                        button.classList.remove('playing');
                        currentPreviewAudio = null;
                    }
                }, 3000);
                
                source.onended = () => {
                    button.textContent = '▶';
                    button.classList.remove('playing');
                    if (currentPreviewAudio === source) {
                        currentPreviewAudio = null;
                    }
                };
            }
        }

        function selectSample(sampleId, cardElement) {
            if (cardElement.classList.contains('selected')) {
                // Deselect
                cardElement.classList.remove('selected');
                selectedSamples = selectedSamples.filter(id => id !== sampleId);
            } else if (selectedSamples.length < 5) {
                // Select
                cardElement.classList.add('selected');
                selectedSamples.push(sampleId);
            }
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedSamples.length;
            document.getElementById('selectedCount').textContent = `${count} / 5 selected`;
            
            const continueBtn = document.getElementById('continueBtn');
            if (count === 5) {
                continueBtn.classList.add('active');
            } else {
                continueBtn.classList.remove('active');
            }
        }

        function goToMixer() {
            if (selectedSamples.length !== 5) return;
            
            // Stop any preview
            if (currentPreviewAudio) {
                currentPreviewAudio.stop();
                currentPreviewAudio = null;
            }
            
            document.getElementById('sampleSelection').style.display = 'none';
            document.getElementById('mixerScreen').style.display = 'block';
            
            // Setup mixer channels
            setupMixerChannels();
            
            // Setup master volume control
            setupMasterControls();
        }

        function setupMixerChannels() {
            const channelsContainer = document.getElementById('channels');
            channelsContainer.innerHTML = '';
            
            selectedSamples.forEach((sampleId, index) => {
                const sample = sampleLibrary.find(s => s.id === sampleId);
                
                const channel = document.createElement('div');
                channel.className = 'channel';
                channel.innerHTML = `
                    <div class="channel-header">
                        <div class="channel-name">${sample.name}</div>
                        <div class="channel-category">${sample.category}</div>
                    </div>
                    <button class="play-btn" data-sample-id="${sampleId}">▶</button>
                    <div class="volume-control">
                        <label class="volume-label">Volume</label>
                        <input type="range" class="volume-slider" data-sample-id="${sampleId}" min="0" max="100" value="70">
                    </div>
                `;
                
                channelsContainer.appendChild(channel);
                
                // Add event listeners
                const playBtn = channel.querySelector('.play-btn');
                const volumeSlider = channel.querySelector('.volume-slider');
                
                playBtn.addEventListener('click', () => toggleSample(sampleId, playBtn));
                volumeSlider.addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    const sampleData = loadedSamples[sampleId];
                    if (sampleData && sampleData.gainNode) {
                        sampleData.gainNode.gain.value = volume;
                    }
                });
            });
        }

        function setupMasterControls() {
            const masterVolumeSlider = document.getElementById('masterVolume');
            masterVolumeSlider.addEventListener('input', (e) => {
                const volume = e.target.value / 100;
                if (masterGainNode) {
                    masterGainNode.gain.value = volume;
                }
            });
        }

        function toggleSample(sampleId, buttonElement) {
            const sampleData = loadedSamples[sampleId];
            if (!sampleData) return;
            
            if (sampleData.isPlaying) {
                // Stop sample
                if (sampleData.source) {
                    sampleData.source.stop();
                    sampleData.source = null;
                    sampleData.gainNode = null;
                }
                sampleData.isPlaying = false;
                buttonElement.textContent = '▶';
                buttonElement.classList.remove('playing');
            } else {
                // Start sample
                const source = audioContext.createBufferSource();
                source.buffer = sampleData.buffer;
                source.loop = true;
                
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 0.7;
                
                source.connect(gainNode);
                gainNode.connect(masterGainNode);
                
                source.start();
                
                sampleData.source = source;
                sampleData.gainNode = gainNode;
                sampleData.isPlaying = true;
                buttonElement.textContent = '⏸';
                buttonElement.classList.add('playing');
                
                // Handle if source ends unexpectedly
                source.onended = () => {
                    if (sampleData.source === source) {
                        sampleData.source = null;
                        sampleData.gainNode = null;
                        sampleData.isPlaying = false;
                        buttonElement.textContent = '▶';
                        buttonElement.classList.remove('playing');
                    }
                };
            }
        }

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                await stopRecording();
            }
        }

        async function startRecording() {
            try {
                isRecording = true;
                recordingStartTime = audioContext.currentTime;
                recordedChunks = [];
                
                const recordBtn = document.getElementById('recordBtn');
                recordBtn.textContent = '⏹ Stop Recording';
                recordBtn.classList.add('recording');
                
                // Create media stream from audio context
                const dest = audioContext.createMediaStreamDestination();
                masterGainNode.connect(dest);
                
                mediaRecorder = new MediaRecorder(dest.stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                    recordedAudioURL = URL.createObjectURL(recordedBlob);
                    showRecordingPreview();
                };
                
                mediaRecorder.start();
                
                // Start recording timer
                recordingTimer = setInterval(updateRecordingTimer, 100);
                
                console.log('Recording started');
                
            } catch (error) {
                console.error('Failed to start recording:', error);
                alert('Recording failed to start. Please try again.');
                isRecording = false;
            }
        }

        async function stopRecording() {
            isRecording = false;
            clearInterval(recordingTimer);
            
            const recordBtn = document.getElementById('recordBtn');
            recordBtn.textContent = '● Record';
            recordBtn.classList.remove('recording');
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            console.log('Recording stopped');
        }

        function updateRecordingTimer() {
            if (!isRecording) return;
            
            const elapsed = audioContext.currentTime - recordingStartTime;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            const progress = Math.min(elapsed / maxRecordingTime, 1) * 100;
            
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} / 00:40`;
            
            document.getElementById('timelineProgress').style.width = progress + '%';
            
            if (elapsed >= maxRecordingTime) {
                stopRecording();
            }
        }

        function showRecordingPreview() {
            const controlsPanel = document.querySelector('.controls-panel');
            
            // Remove existing preview if any
            const existingPreview = controlsPanel.querySelector('.recording-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // Create new preview
            const previewDiv = document.createElement('div');
            previewDiv.className = 'recording-preview';
            
            previewDiv.innerHTML = `
                <p style="margin: 0 0 10px 0; color: #FDB827; font-weight: bold;">🎵 Recording Ready!</p>
                <audio controls style="width: 100%; margin: 10px 0;">
                    <source src="${recordedAudioURL}" type="audio/webm">
                </audio>
                <p style="margin: 10px 0 0 0; font-size: 0.9rem; opacity: 0.8;">Ready to export!</p>
            `;
            
            // Insert before export button
            const exportBtn = controlsPanel.querySelector('.export-btn');
            controlsPanel.insertBefore(previewDiv, exportBtn);
        }

        function stopAll() {
            // Stop all playing samples
            selectedSamples.forEach(sampleId => {
                const sampleData = loadedSamples[sampleId];
                if (sampleData && sampleData.isPlaying) {
                    if (sampleData.source) {
                        sampleData.source.stop();
                        sampleData.source = null;
                        sampleData.gainNode = null;
                    }
                    sampleData.isPlaying = false;
                }
            });
            
            // Update UI
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.textContent = '▶';
                btn.classList.remove('playing');
            });
            
            // Stop recording if active
            if (isRecording) {
                stopRecording();
            }
            
            // Reset timeline
            document.getElementById('timelineProgress').style.width = '0%';
            document.getElementById('timer').textContent = '00:00 / 00:40';
        }

        async function exportMix() {
            stopAll();
            
            if (!recordedBlob) {
                alert('No recording found. Please record your beat first!');
                return;
            }
            
            // Show export screen
            document.getElementById('mixerScreen').style.display = 'none';
            document.getElementById('exportScreen').style.display = 'block';
            
            console.log('Mix exported with recording:', recordedBlob);
        }

        // Upload audio file to tmpfiles.org
        async function uploadAudioFile(audioBlob, filename) {
            console.log('Uploading file:', filename);
            
            try {
                const formData = new FormData();
                formData.append('file', audioBlob, filename);
                
                const response = await fetch('https://tmpfiles.org/api/v1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                console.log('Upload response:', result);
                
                if (result.status === 'success' && result.data && result.data.url) {
                    const downloadUrl = result.data.url.replace('tmpfiles.org/', 'tmpfiles.org/dl/');
                    console.log('Upload successful:', downloadUrl);
                    return downloadUrl;
                }
                
                throw new Error('Upload failed: ' + (result.status || 'Unknown error'));
                
            } catch (error) {
                console.error('Upload failed:', error);
                const mailtoLink = `mailto:?subject=Untold Beat Creation&body=Sorry, we couldn't upload your beat automatically. Please contact support to receive your audio file.`;
                return mailtoLink;
            }
        }

        async function sendEmail() {
            const emailInput = document.getElementById('emailInput');
            const email = emailInput.value.trim();
            
            if (!email) {
                alert('Please enter a valid email address');
                return;
            }
            
            if (!recordedBlob) {
                alert('No recording found to send!');
                return;
            }
            
            const sendBtn = event.target;
            sendBtn.disabled = true;
            sendBtn.textContent = 'Uploading & Sending...';
            
            try {
                // Create filename
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                const filename = `untold-beat-${dateStr}-${timeStr}.wav`;
                
                // Upload file
                const downloadLink = await uploadAudioFile(recordedBlob, filename);
                
                // Create beat summary
                const selectedSampleNames = selectedSamples.map(id => {
                    const sample = sampleLibrary.find(s => s.id === id);
                    return sample ? sample.name : 'Unknown';
                });
                
                // Email parameters
                const templateParams = {
                    to_email: email,
                    to_name: email.split('@')[0],
                    user_name: email.split('@')[0],
                    beat_samples: selectedSampleNames.join(', '),
                    creation_date: now.toLocaleDateString(),
                    creation_time: now.toLocaleTimeString(),
                    reply_to: email,
                    download_link: downloadLink,
                    filename: filename
                };
                
                // Send email
                const result = await emailjs.send(
                    'service_0qjyioy',
                    'template_rre9c5j',
                    templateParams
                );
                
                console.log('Email sent successfully:', result);
                
                // Show success
                const successMsg = document.getElementById('successMessage');
                if (downloadLink.startsWith('https://')) {
                    successMsg.innerHTML = `
                        🎉 Beat sent successfully! Check your email.<br>
                        <a href="${downloadLink}" target="_blank" style="color: #FDB827; text-decoration: underline;">Or download directly here</a>
                    `;
                } else {
                    successMsg.innerHTML = `🎉 Email sent! Please check your email for details.`;
                }
                successMsg.style.display = 'block';
                emailInput.value = '';
                
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 8000);
                
            } catch (error) {
                console.error('Process failed:', error);
                alert('Failed to send email. Please try again.');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send My Beat';
            }
        }

        function goToSampleSelection() {
            stopAll();
            document.getElementById('mixerScreen').style.display = 'none';
            document.getElementById('sampleSelection').style.display = 'block';
        }

        function goToMixerFromExport() {
            document.getElementById('exportScreen').style.display = 'none';
            document.getElementById('mixerScreen').style.display = 'block';
        }

        function startOver() {
            stopAll();
            selectedSamples = [];
            recordedBlob = null;
            recordedAudioURL = null;
            document.getElementById('exportScreen').style.display = 'none';
            document.getElementById('introScreen').style.display = 'block';
            
            // Reset UI
            document.querySelectorAll('.sample-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateSelectedCount();
            
            // Remove recording preview if exists
            const previewDiv = document.querySelector('.recording-preview');
            if (previewDiv) {
                previewDiv.remove();
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Untold Beat Mixer loaded');
        });

        // Cleanup
        window.addEventListener('beforeunload', function() {
            stopAll();
            if (currentPreviewAudio) {
                currentPreviewAudio.stop();
            }
        });
    </script>
</body>
</html>